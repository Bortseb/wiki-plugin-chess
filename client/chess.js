/* wiki-plugin-chess - 0.2.0 - Wed, 05 Mar 2025 04:29:39 GMT */
(()=>{var q="w",A="b",y="p",Se="n",ne="b",J="r",K="q",S="k",ve="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",V=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(e,t){let{color:s,piece:i,from:r,to:o,flags:n,captured:a,promotion:d}=t,l=I(r),_=I(o);this.color=s,this.piece=i,this.from=l,this.to=_,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=l+_,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(let c in f)f[c]&n&&(this.flags+=z[c]);a&&(this.captured=a),d&&(this.promotion=d,this.lan+=d)}isCapture(){return this.flags.indexOf(z.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(z.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(z.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(z.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(z.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(z.BIG_PAWN)>-1}},x=-1,z={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"};var f={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},m={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},_e={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ae={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ge=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],$e=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Ke={p:1,n:2,b:4,r:8,q:16,k:32},He="pnbrqkPNBRQK",Le=[Se,ne,J,K],ze=7,We=6,Ye=1,je=0,oe={[S]:f.KSIDE_CASTLE,[K]:f.QSIDE_CASTLE},B={w:[{square:m.a1,flag:f.QSIDE_CASTLE},{square:m.h1,flag:f.KSIDE_CASTLE}],b:[{square:m.a8,flag:f.QSIDE_CASTLE},{square:m.h8,flag:f.KSIDE_CASTLE}]},Qe={b:Ye,w:We},Ve=["1-0","0-1","1/2-1/2","*"];function W(h){return h>>4}function ee(h){return h&15}function Ne(h){return"0123456789".indexOf(h)!==-1}function I(h){let e=ee(h),t=W(h);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function Z(h){return h===q?A:q}function Xe(h){let e=h.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let i=e[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let o=0;o<i.length;o++){let n=0,a=!1;for(let d=0;d<i[o].length;d++)if(Ne(i[o][d])){if(a)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};n+=parseInt(i[o][d],10),a=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[o][d]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};n+=1,a=!1}if(n!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:o,regex:n}of r){if(!n.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${o} king`};if((e[0].match(n)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${o} kings`}}return Array.from(i[0]+i[7]).some(o=>o.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Ze(h,e){let t=h.from,s=h.to,i=h.piece,r=0,o=0,n=0;for(let a=0,d=e.length;a<d;a++){let l=e[a].from,_=e[a].to,c=e[a].piece;i===c&&t!==l&&s===_&&(r++,W(t)===W(l)&&o++,ee(t)===ee(l)&&n++)}return r>0?o>0&&n>0?I(t):n>0?I(t).charAt(1):I(t).charAt(0):""}function G(h,e,t,s,i,r=void 0,o=f.NORMAL){let n=W(s);if(i===y&&(n===ze||n===je))for(let a=0;a<Le.length;a++){let d=Le[a];h.push({color:e,from:t,to:s,piece:i,captured:r,promotion:d,flags:o|f.PROMOTION})}else h.push({color:e,from:t,to:s,piece:i,captured:r,flags:o})}function Oe(h){let e=h.charAt(0);return e>="a"&&e<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:y:(e=e.toLowerCase(),e==="o"?S:e)}function we(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function ke(h){return h.split(" ").slice(0,4).join(" ")}var ae=class{_board=new Array(128);_turn=q;_header={};_kings={w:x,b:x};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_positionCount={};constructor(e=ve,{skipValidation:t=!1}={}){this.load(e,{skipValidation:t})}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:x,b:x},this._turn=q,this._castling={w:0,b:0},this._epSquare=x,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){let n=["-","-","0","1"];e=i.concat(n.slice(-(6-i.length))).join(" ")}if(i=e.split(/\s+/),!t){let{ok:n,error:a}=Xe(e);if(!n)throw new Error(a)}let r=i[0],o=0;this.clear({preserveHeaders:s});for(let n=0;n<r.length;n++){let a=r.charAt(n);if(a==="/")o+=8;else if(Ne(a))o+=parseInt(a,10);else{let d=a<"a"?q:A;this._put({type:a.toLowerCase(),color:d},I(o)),o++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=f.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=f.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=f.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=f.QSIDE_CASTLE),this._epSquare=i[3]==="-"?x:m[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._updateSetup(e),this._incPositionCount(e)}fen(){let e=0,t="";for(let r=m.a8;r<=m.h1;r++){if(this._board[r]){e>0&&(t+=e,e=0);let{color:o,type:n}=this._board[r];t+=o===q?n.toUpperCase():n.toLowerCase()}else e++;r+1&136&&(e>0&&(t+=e),r!==m.h1&&(t+="/"),e=0,r+=8)}let s="";this._castling[q]&f.KSIDE_CASTLE&&(s+="K"),this._castling[q]&f.QSIDE_CASTLE&&(s+="Q"),this._castling[A]&f.KSIDE_CASTLE&&(s+="k"),this._castling[A]&f.QSIDE_CASTLE&&(s+="q"),s=s||"-";let i="-";if(this._epSquare!==x){let r=this._epSquare+(this._turn===q?16:-16),o=[r+1,r-1];for(let n of o){if(n&136)continue;let a=this._turn;if(this._board[n]?.color===a&&this._board[n]?.type===y){this._makeMove({color:a,from:n,to:this._epSquare,piece:y,captured:y,flags:f.EP_CAPTURE});let d=!this._isKingAttacked(a);if(this._undoMove(),d){i=I(this._epSquare);break}}}}return[t,this._turn,s,i,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==ve?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(ve)}get(e){return this._board[m[e]]}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:t},s){if(He.indexOf(e.toLowerCase())===-1||!(s in m))return!1;let i=m[s];if(e==S&&!(this._kings[t]==x||this._kings[t]==i))return!1;let r=this._board[i];return r&&r.type===S&&(this._kings[r.color]=x),this._board[i]={type:e,color:t},e===S&&(this._kings[t]=i),!0}remove(e){let t=this.get(e);return delete this._board[m[e]],t&&t.type===S&&(this._kings[t.color]=x),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){let e=this._board[m.e1]?.type===S&&this._board[m.e1]?.color===q,t=this._board[m.e8]?.type===S&&this._board[m.e8]?.color===A;(!e||this._board[m.a1]?.type!==J||this._board[m.a1]?.color!==q)&&(this._castling.w&=~f.QSIDE_CASTLE),(!e||this._board[m.h1]?.type!==J||this._board[m.h1]?.color!==q)&&(this._castling.w&=~f.KSIDE_CASTLE),(!t||this._board[m.a8]?.type!==J||this._board[m.a8]?.color!==A)&&(this._castling.b&=~f.QSIDE_CASTLE),(!t||this._board[m.h8]?.type!==J||this._board[m.h8]?.color!==A)&&(this._castling.b&=~f.KSIDE_CASTLE)}_updateEnPassantSquare(){if(this._epSquare===x)return;let e=this._epSquare+(this._turn===q?-16:16),t=this._epSquare+(this._turn===q?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||this._board[t]?.color!==Z(this._turn)||this._board[t]?.type!==y){this._epSquare=x;return}let i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===y;s.some(i)||(this._epSquare=x)}_attacked(e,t,s){let i=[];for(let r=m.a8;r<=m.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==e)continue;let o=this._board[r],n=r-t;if(n===0)continue;let a=n+119;if(Ge[a]&Ke[o.type]){if(o.type===y){if(n>0&&o.color===q||n<=0&&o.color===A)if(s)i.push(I(r));else return!0;continue}if(o.type==="n"||o.type==="k")if(s){i.push(I(r));continue}else return!0;let d=$e[a],l=r+d,_=!1;for(;l!==t;){if(this._board[l]!=null){_=!0;break}l+=d}if(!_)if(s){i.push(I(r));continue}else return!0}}return s?i:!1}attackers(e,t){return t?this._attacked(t,m[e],!0):this._attacked(this._turn,m[e],!0)}_isKingAttacked(e){let t=this._kings[e];return t===-1?!1:this._attacked(Z(e),t)}isAttacked(e,t){return this._attacked(t,m[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let e={b:0,n:0,r:0,q:0,k:0,p:0},t=[],s=0,i=0;for(let r=m.a8;r<=m.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}let o=this._board[r];o&&(e[o.type]=o.type in e?e[o.type]+1:1,o.type===ne&&t.push(i),s++)}if(s===2)return!0;if(s===3&&(e[ne]===1||e[Se]===1))return!0;if(s===e[ne]+2){let r=0,o=t.length;for(let n=0;n<o;n++)r+=t[n];if(r===0||r===o)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){let i=this._moves({square:t,piece:s});return e?i.map(r=>new V(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){let i=s?s.toLowerCase():void 0,r=t?.toLowerCase(),o=[],n=this._turn,a=Z(n),d=m.a8,l=m.h1,_=!1;if(i)if(i in m)d=l=m[i],_=!0;else return[];for(let p=d;p<=l;p++){if(p&136){p+=7;continue}if(!this._board[p]||this._board[p].color===a)continue;let{type:w}=this._board[p],k;if(w===y){if(r&&r!==w)continue;k=p+_e[n][0],this._board[k]||(G(o,n,p,k,y),k=p+_e[n][1],Qe[n]===W(p)&&!this._board[k]&&G(o,n,p,k,y,void 0,f.BIG_PAWN));for(let O=2;O<4;O++)k=p+_e[n][O],!(k&136)&&(this._board[k]?.color===a?G(o,n,p,k,y,this._board[k].type,f.CAPTURE):k===this._epSquare&&G(o,n,p,k,y,y,f.EP_CAPTURE))}else{if(r&&r!==w)continue;for(let O=0,N=Ae[w].length;O<N;O++){let Q=Ae[w][O];for(k=p;k+=Q,!(k&136);){if(!this._board[k])G(o,n,p,k,w);else{if(this._board[k].color===n)break;G(o,n,p,k,w,this._board[k].type,f.CAPTURE);break}if(w===Se||w===S)break}}}}if((r===void 0||r===S)&&(!_||l===this._kings[n])){if(this._castling[n]&f.KSIDE_CASTLE){let p=this._kings[n],w=p+2;!this._board[p+1]&&!this._board[w]&&!this._attacked(a,this._kings[n])&&!this._attacked(a,p+1)&&!this._attacked(a,w)&&G(o,n,this._kings[n],w,S,void 0,f.KSIDE_CASTLE)}if(this._castling[n]&f.QSIDE_CASTLE){let p=this._kings[n],w=p-2;!this._board[p-1]&&!this._board[p-2]&&!this._board[p-3]&&!this._attacked(a,this._kings[n])&&!this._attacked(a,p-1)&&!this._attacked(a,w)&&G(o,n,this._kings[n],w,S,void 0,f.QSIDE_CASTLE)}}if(!e||this._kings[n]===-1)return o;let c=[];for(let p=0,w=o.length;p<w;p++)this._makeMove(o[p]),this._isKingAttacked(n)||c.push(o[p]),this._undoMove();return c}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(typeof e=="object"){let r=this._moves();for(let o=0,n=r.length;o<n;o++)if(e.from===I(r[o].from)&&e.to===I(r[o].to)&&(!("promotion"in r[o])||e.promotion===r[o].promotion)){s=r[o];break}}if(!s)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);let i=new V(this,s);return this._makeMove(s),this._incPositionCount(i.after),i}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){let t=this._turn,s=Z(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&f.EP_CAPTURE&&(this._turn===A?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===S){if(this._kings[t]=e.to,e.flags&f.KSIDE_CASTLE){let i=e.to-1,r=e.to+1;this._board[i]=this._board[r],delete this._board[r]}else if(e.flags&f.QSIDE_CASTLE){let i=e.to+1,r=e.to-2;this._board[i]=this._board[r],delete this._board[r]}this._castling[t]=0}if(this._castling[t]){for(let i=0,r=B[t].length;i<r;i++)if(e.from===B[t][i].square&&this._castling[t]&B[t][i].flag){this._castling[t]^=B[t][i].flag;break}}if(this._castling[s]){for(let i=0,r=B[s].length;i<r;i++)if(e.to===B[s][i].square&&this._castling[s]&B[s][i].flag){this._castling[s]^=B[s][i].flag;break}}e.flags&f.BIG_PAWN?t===A?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=x,e.piece===y?this._halfMoves=0:e.flags&(f.CAPTURE|f.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===A&&this._moveNumber++,this._turn=s}undo(){let e=this._undoMove();if(e){let t=new V(this,e);return this._decPositionCount(t.after),t}return null}_undoMove(){let e=this._history.pop();if(e===void 0)return null;let t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;let s=this._turn,i=Z(s);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&f.EP_CAPTURE){let r;s===A?r=t.to-16:r=t.to+16,this._board[r]={type:y,color:i}}else this._board[t.to]={type:t.captured,color:i};if(t.flags&(f.KSIDE_CASTLE|f.QSIDE_CASTLE)){let r,o;t.flags&f.KSIDE_CASTLE?(r=t.to+1,o=t.to-1):(r=t.to-2,o=t.to+1),this._board[r]=this._board[o],delete this._board[o]}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){let s=[],i=!1;for(let c in this._header)s.push("["+c+' "'+this._header[c]+'"]'+e),i=!0;i&&this._history.length&&s.push(e);let r=c=>{let p=this._comments[this.fen()];if(typeof p<"u"){let w=c.length>0?" ":"";c=`${c}${w}{${p}}`}return c},o=[];for(;this._history.length>0;)o.push(this._undoMove());let n=[],a="";for(o.length===0&&n.push(r(""));o.length>0;){a=r(a);let c=o.pop();if(!c)break;if(!this._history.length&&c.color==="b"){let p=`${this._moveNumber}. ...`;a=a?`${a} ${p}`:p}else c.color==="w"&&(a.length&&n.push(a),a=this._moveNumber+".");a=a+" "+this._moveToSan(c,this._moves({legal:!0})),this._makeMove(c)}if(a.length&&n.push(r(a)),typeof this._header.Result<"u"&&n.push(this._header.Result),t===0)return s.join("")+n.join(" ");let d=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},l=function(c,p){for(let w of p.split(" "))if(w){if(c+w.length>t){for(;d();)c--;s.push(e),c=0}s.push(w),c+=w.length,s.push(" "),c++}return d()&&c--,c},_=0;for(let c=0;c<n.length;c++){if(_+n[c].length>t&&n[c].includes("{")){_=l(_,n[c]);continue}_+n[c].length>t&&c!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),_=0):c!==0&&(s.push(" "),_++),s.push(n[c]),_+=n[c].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t,this._header}removeHeader(e){return e in this._header?(delete this._header[e],!0):!1}getHeaders(){return this._header}loadPgn(e,{strict:t=!1,newlineChar:s=`\r?
`}={}){function i(g){return g.replace(/\\/g,"\\")}function r(g){let M={},U=g.split(new RegExp(i(s))),ge="",xe="";for(let re=0;re<U.length;re++){let Me=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;ge=U[re].replace(Me,"$1"),xe=U[re].replace(Me,"$2"),ge.trim().length>0&&(M[ge]=xe)}return M}e=e.trim();let n=new RegExp("^(\\[((?:"+i(s)+")|.)*\\])((?:\\s*"+i(s)+"){2}|(?:\\s*"+i(s)+")*$)").exec(e),a=n&&n.length>=2?n[1]:"";this.reset();let d=r(a),l="";for(let g in d)g.toLowerCase()==="fen"&&(l=d[g]),this.header(g,d[g]);if(!t)l&&this.load(l,{preserveHeaders:!0});else if(d.SetUp==="1"){if(!("FEN"in d))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(d.FEN,{preserveHeaders:!0})}function _(g){return Array.from(g).map(function(M){return M.charCodeAt(0)<128?M.charCodeAt(0).toString(16):encodeURIComponent(M).replace(/%/g,"").toLowerCase()}).join("")}function c(g){return g.length==0?"":decodeURIComponent("%"+(g.match(/.{1,2}/g)||[]).join("%"))}let p=function(g){return g=g.replace(new RegExp(i(s),"g")," "),`{${_(g.slice(1,g.length-1))}}`},w=function(g){if(g.startsWith("{")&&g.endsWith("}"))return c(g.slice(1,g.length-1))},k=e.replace(a,"").replace(new RegExp(`({[^}]*})+?|;([^${i(s)}]*)`,"g"),function(g,M,U){return M!==void 0?p(M):" "+p(`{${U.slice(1)}}`)}).replace(new RegExp(i(s),"g")," "),O=/(\([^()]+\))+?/g;for(;O.test(k);)k=k.replace(O,"");k=k.replace(/\d+\.(\.\.)?/g,""),k=k.replace(/\.\.\./g,""),k=k.replace(/\$\d+/g,"");let N=k.trim().split(new RegExp(/\s+/));N=N.filter(g=>g!=="");let Q="";for(let g=0;g<N.length;g++){let M=w(N[g]);if(M!==void 0){this._comments[this.fen()]=M;continue}let U=this._moveFromSan(N[g],t);if(U==null)if(Ve.indexOf(N[g])>-1)Q=N[g];else throw new Error(`Invalid move in PGN: ${N[g]}`);else Q="",this._makeMove(U),this._incPositionCount(this.fen())}Q&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",Q)}_moveToSan(e,t){let s="";if(e.flags&f.KSIDE_CASTLE)s="O-O";else if(e.flags&f.QSIDE_CASTLE)s="O-O-O";else{if(e.piece!==y){let i=Ze(e,t);s+=e.piece.toUpperCase()+i}e.flags&(f.CAPTURE|f.EP_CAPTURE)&&(e.piece===y&&(s+=I(e.from)[0]),s+="x"),s+=I(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){let s=we(e),i=Oe(s),r=this._moves({legal:!0,piece:i});for(let c=0,p=r.length;c<p;c++)if(s===we(this._moveToSan(r[c],r)))return r[c];if(t)return null;let o,n,a,d,l,_=!1;if(n=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),n?(o=n[1],a=n[2],d=n[3],l=n[4],a.length==1&&(_=!0)):(n=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),n&&(o=n[1],a=n[2],d=n[3],l=n[4],a.length==1&&(_=!0))),i=Oe(s),r=this._moves({legal:!0,piece:o||i}),!d)return null;for(let c=0,p=r.length;c<p;c++)if(a){if((!o||o.toLowerCase()==r[c].piece)&&m[a]==r[c].from&&m[d]==r[c].to&&(!l||l.toLowerCase()==r[c].promotion))return r[c];if(_){let w=I(r[c].from);if((!o||o.toLowerCase()==r[c].piece)&&m[d]==r[c].to&&(a==w[0]||a==w[1])&&(!l||l.toLowerCase()==r[c].promotion))return r[c]}}else if(s===we(this._moveToSan(r[c],r)).replace("x",""))return r[c];return null}ascii(){let e=`   +------------------------+
`;for(let t=m.a8;t<=m.h1;t++){if(ee(t)===0&&(e+=" "+"87654321"[W(t)]+" |"),this._board[t]){let s=this._board[t].type,r=this._board[t].color===q?s.toUpperCase():s.toLowerCase();e+=" "+r+" "}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){let t=this._moves({legal:!1}),s=0,i=this._turn;for(let r=0,o=t.length;r<o;r++)this._makeMove(t[r]),this._isKingAttacked(i)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}turn(){return this._turn}board(){let e=[],t=[];for(let s=m.a8;s<=m.h1;s++)this._board[s]==null?t.push(null):t.push({square:I(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in m){let t=m[e];return(W(t)+ee(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){let t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){let i=t.pop();if(!i)break;e?s.push(new V(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(e){let t=ke(e);return this._positionCount[t]||0}_incPositionCount(e){let t=ke(e);this._positionCount[t]===void 0&&(this._positionCount[t]=0),this._positionCount[t]+=1}_decPositionCount(e){let t=ke(e);this._positionCount[t]===1?delete this._positionCount[t]:this._positionCount[t]-=1}_pruneComments(){let e=[],t={},s=i=>{i in this._comments&&(t[i]=this._comments[i])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){let i=e.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{let t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(let i of[S,K])t[i]!==void 0&&(t[i]?this._castling[e]|=oe[i]:this._castling[e]&=~oe[i]);this._updateCastlingRights();let s=this.getCastlingRights(e);return(t[S]===void 0||t[S]===s[S])&&(t[K]===void 0||t[K]===s[K])}getCastlingRights(e){return{[S]:(this._castling[e]&oe[S])!==0,[K]:(this._castling[e]&oe[K])!==0}}moveNumber(){return this._moveNumber}};var X={start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",empty:"8/8/8/8/8/8/8/8"},T=class h{constructor(e=X.empty){this.squares=new Array(64).fill(null),this.setFen(e)}setFen(e=X.empty){let t=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let s=0;s<8;s++){let i=t[7-s].replace(/\d/g,r=>{let o=parseInt(r),n="";for(let a=0;a<o;a++)n+="-";return n});for(let r=0;r<8;r++){let o=i.substring(r,r+1),n=null;o!=="-"&&(o.toUpperCase()===o?n=`w${o.toLowerCase()}`:n=`b${o}`),this.squares[s*8+r]=n}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){let r=this.squares[t*8+i];if(!r)s++;else{s>0&&(e[7-t]+=s,s=0);let o=r.substring(0,1),n=r.substring(1,2);o==="w"?e[7-t]+=n.toUpperCase():e[7-t]+=n}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=void 0,t=void 0,s=["k","q","r","b","n","p"]){let i=[],r=(o,n)=>s.indexOf(o.name)-s.indexOf(n.name);for(let o=0;o<64;o++){let n=this.squares[o];if(n){let a=n.charAt(1),d=n.charAt(0),l=h.indexToSquare(o);if(t&&t!==a||e&&e!==d)continue;i.push({name:a,type:a,color:d,position:l,square:l})}}return s&&i.sort(r),i}movePiece(e,t){if(!this.squares[h.squareToIndex(e)]){console.warn("no piece on",e);return}this.squares[h.squareToIndex(t)]=this.squares[h.squareToIndex(e)],this.squares[h.squareToIndex(e)]=null}setPiece(e,t){this.squares[h.squareToIndex(e)]=t}getPiece(e){return this.squares[h.squareToIndex(e)]}static squareToIndex(e){let t=h.squareToCoordinates(e);return t[0]+t[1]*8}static indexToSquare(e){return this.coordinatesToSquare([Math.floor(e%8),e/8])}static squareToCoordinates(e){let t=e.charCodeAt(0)-97,s=e.charCodeAt(1)-49;return[t,s]}static coordinatesToSquare(e){let t=String.fromCharCode(e[0]+97),s=String.fromCharCode(e[1]+49);return t+s}toString(){return this.getFen()}clone(){let e=new h;return e.squares=this.squares.slice(0),e}};var he=class{constructor(){this.position=new T,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.squareSelectEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(e,t={}){let s=this.extensionPoints[e],i=Object.assign({},t);i.extensionPoint=e;let r=!0;if(s)for(let o of s)o(i)===!1&&(r=!1);return r}};var De="http://www.w3.org/2000/svg",b=class{static createSvg(e=void 0){let t=document.createElementNS(De,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s={}){let i=document.createElementNS(De,t);t==="use"&&(s["xlink:href"]=s.href);for(let r in s)if(s.hasOwnProperty(r))if(r.indexOf(":")!==-1){let o=r.split(":");i.setAttributeNS("http://www.w3.org/1999/"+o[0],o[1],s[r])}else i.setAttribute(r,s[r]);return e.appendChild(i),i}static removeElement(e){if(!e){console.warn("removeElement, element is",e);return}e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode")}};var v={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",beforeRedrawBoard:"beforeRedrawBoard",afterRedrawBoard:"afterRedrawBoard",redrawBoard:"redrawBoard",animation:"animation",destroy:"destroy"},H=class{constructor(e){this.chessboard=e}registerExtensionPoint(e,t){e===v.redrawBoard&&(console.warn("EXTENSION_POINT.redrawBoard is deprecated, use EXTENSION_POINT.afterRedrawBoard"),e=v.afterRedrawBoard),this.chessboard.state.extensionPoints[e]||(this.chessboard.state.extensionPoints[e]=[]),this.chessboard.state.extensionPoints[e].push(t)}registerMethod(e,t){console.warn("registerMethod is deprecated, just add methods directly to the chessboard instance"),this.chessboard[e]?log.error("method",e,"already exists"):this.chessboard[e]=(...s)=>t.apply(this,s)}};var P=class h{static delegate(e,t,s,i){let r=function(o){let n=o.target;for(;n&&n!==this;)n.matches(s)&&i.call(n,o),n=n.parentNode};return e.addEventListener(t,r),{remove:function(){e.removeEventListener(t,r)}}}static mergeObjects(e,t){let s=i=>i&&typeof i=="object";if(!s(e)||!s(t))return t;for(let i of Object.keys(t))t[i]instanceof Object&&Object.assign(t[i],h.mergeObjects(e[i],t[i]));return Object.assign(e||{},t),e}static createDomElement(e){let t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}static createTask(){let e,t,s=new Promise(function(i,r){e=i,t=r});return s.resolve=e,s.reject=t,s}static isAbsoluteUrl(e){return e.indexOf("://")!==-1||e.startsWith("/")}};var Ee={start:"start",frame:"frame",end:"end"},ye=class{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}},D={move:0,appear:1,disappear:2},te=class h{constructor(e,t,s,i,r){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s),this.view.positionsAnimationTask=P.createTask(),this.view.chessboard.state.invokeExtensionPoints(v.animation,{type:Ee.start})}static seekChanges(e,t){let s=[],i=[],r=[];for(let o=0;o<64;o++){let n=e[o],a=t[o];a!==n&&(a&&s.push({piece:a,index:o}),n&&i.push({piece:n,index:o}))}return s.forEach(o=>{let n=8,a=null;i.forEach(d=>{if(o.piece===d.piece){let l=h.squareDistance(o.index,d.index);l<n&&(a=d,n=l)}}),a?(i.splice(i.indexOf(a),1),r.push({type:D.move,piece:o.piece,atIndex:a.index,toIndex:o.index})):r.push({type:D.appear,piece:o.piece,atIndex:o.index})}),i.forEach(o=>{r.push({type:D.disappear,piece:o.piece,atIndex:o.index})}),r}createAnimation(e,t){let s=h.seekChanges(e,t),i=[];return s.forEach(r=>{let o={type:r.type};switch(r.type){case D.move:o.element=this.view.getPieceElement(T.indexToSquare(r.atIndex)),o.element.parentNode.appendChild(o.element),o.atPoint=this.view.indexToPoint(r.atIndex),o.toPoint=this.view.indexToPoint(r.toIndex);break;case D.appear:o.element=this.view.drawPieceOnSquare(T.indexToSquare(r.atIndex),r.piece),o.element.style.opacity=0;break;case D.disappear:o.element=this.view.getPieceElement(T.indexToSquare(r.atIndex));break}i.push(o)}),i}animationStep(e){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=e);let t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===D.disappear&&b.removeElement(r.element)}),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(v.animation,{type:Ee.end}),this.callback();return}let s=Math.min(1,t/this.duration),i=s<.5?2*s*s:-1+(4-2*s)*s;(isNaN(i)||i>.99)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case D.move:r.element.transform.baseVal.removeItem(0);let o=this.view.svg.createSVGTransform();o.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(o);break;case D.appear:r.element.style.opacity=Math.round(i*100)/100;break;case D.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)}),this.view.chessboard.state.invokeExtensionPoints(v.animation,{type:Ee.frame,progress:i})}static squareDistance(e,t){let s=e%8,i=Math.floor(e/8),r=t%8,o=Math.floor(t/8);return Math.max(Math.abs(o-i),Math.abs(r-s))}},le=class extends ye{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new te(this.chessboard.view,e,t,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()})}))}async enqueueTurnBoard(e,t,s){return super.enqueue(()=>new Promise(i=>{let r=new T(X.empty),o=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(o=o/(1+Math.pow(this.queue.length/5,2))),new te(this.chessboard.view,e,r,s?o:0,()=>{this.chessboard.state.orientation=t,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new te(this.chessboard.view,r,e,s?o:0,()=>{this.chessboard.view.redrawPieces(e.squares),i()})})}))}};var u={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},se={secondClick:"secondClick",secondaryClick:"secondaryClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},Re=4,ce=class{constructor(e){this.view=e,this.chessboard=e.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(u.waitForInputStart)}moveInputStartedCallback(e){let t=this.view.moveInputStartedCallback(e);return t&&(this.chessboard.state.moveInputProcess=P.createTask(),this.chessboard.state.moveInputProcess.then(s=>{(this.moveInputState===u.waitForInputStart||this.moveInputState===u.moveDone)&&this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,s)})),t}movingOverSquareCallback(e,t){this.view.movingOverSquareCallback(e,t)}validateMoveInputCallback(e,t){let s=this.view.validateMoveInputCallback(e,t);return this.chessboard.state.moveInputProcess.resolve(s),s}moveInputCanceledCallback(e,t,s){this.view.moveInputCanceledCallback(e,t,s),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(e,t=void 0){let s=this.moveInputState;switch(this.moveInputState=e,e){case u.waitForInputStart:break;case u.pieceClickedThreshold:if(u.waitForInputStart!==s&&u.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=t.square,this.toSquare=null,this.movedPiece=t.piece,this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener){if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("4b74af");this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener))}else throw Error("94ad0c");break;case u.clickTo:this.draggablePiece&&(b.removeElement(this.draggablePiece),this.draggablePiece=null),s===u.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case u.secondClickThreshold:if(u.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case u.dragTo:if(u.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case u.clickDragTo:if(u.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case u.moveDone:if([u.dragTo,u.clickTo,u.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,s===u.clickTo).then(()=>{s===u.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(u.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(u.reset));break;case u.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(b.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(u.waitForInputStart);let i=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let r=0;r<i.length;r++)i[r].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=b.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;let t=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),s=b.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(!(e.type==="mousedown"&&e.button===0||e.type==="touchstart"))return;let t=e.target.getAttribute("data-square");if(!t)return;let s=this.chessboard.getPiece(t),i;if(s&&(i=s?s.substring(0,1):null,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==u.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(e.type==="mousedown"?r={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(r={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===u.waitForInputStart&&s&&this.moveInputStartedCallback(t))this.setMoveInputState(u.pieceClickedThreshold,{square:t,piece:s,point:r,type:e.type});else if(this.moveInputState===u.clickTo)if(t===this.fromSquare)this.setMoveInputState(u.secondClickThreshold,{square:t,piece:s,point:r,type:e.type});else{let o=this.chessboard.getPiece(t),n=o?o.substring(0,1):null,a=this.chessboard.getPiece(this.fromSquare),d=a?a.substring(0,1):null;i&&d===n?(this.moveInputCanceledCallback(this.fromSquare,t,se.clickedAnotherPiece),this.moveInputStartedCallback(t)?this.setMoveInputState(u.pieceClickedThreshold,{square:t,piece:o,point:r,type:e.type}):this.setMoveInputState(u.reset)):this.setMoveInputState(u.moveDone,{square:t})}}}onPointerMove(e){let t,s,i,r,o;if(e.type==="mousemove"?(i=e.clientX,r=e.clientY,t=e.pageX,s=e.pageY,o=e.target):e.type==="touchmove"&&(i=e.touches[0].clientX,r=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,o=document.elementFromPoint(i,r)),this.moveInputState===u.pieceClickedThreshold||this.moveInputState===u.secondClickThreshold)(Math.abs(this.startPoint.x-i)>Re||Math.abs(this.startPoint.y-r)>Re)&&(this.moveInputState===u.secondClickThreshold?this.setMoveInputState(u.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(u.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(t,s));else if(this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo||this.moveInputState===u.clickTo){if(o&&o.getAttribute&&o.parentElement===this.view.boardGroup){let n=o.getAttribute("data-square");n!==this.fromSquare&&n!==this.toSquare?(this.toSquare=n,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):n===this.fromSquare&&this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));this.view.chessboard.state.inputEnabled()&&(this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){let s=t.getAttribute("data-square");if(s)this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo?this.fromSquare===s?this.moveInputState===u.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(s,null,se.draggedBack),this.setMoveInputState(u.reset)):this.setMoveInputState(u.clickTo,{square:s}):this.setMoveInputState(u.moveDone,{square:s}):this.moveInputState===u.pieceClickedThreshold?this.setMoveInputState(u.clickTo,{square:s}):this.moveInputState===u.secondClickThreshold&&(this.setMoveInputState(u.reset),this.moveInputCanceledCallback(s,null,se.secondClick));else{this.view.redrawPieces();let i=this.fromSquare;this.setMoveInputState(u.reset),this.moveInputCanceledCallback(i,null,se.movedOutOfBoard)}}else this.view.redrawPieces(),this.setMoveInputState(u.reset)}onContextMenu(e){e.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(u.reset),this.moveInputCanceledCallback(this.fromSquare,null,se.secondaryClick)}isDragging(){return this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo}destroy(){this.setMoveInputState(u.reset)}};var C={white:"w",black:"b"},E={moveInputStarted:"moveInputStarted",movingOverSquare:"movingOverSquare",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled",moveInputFinished:"moveInputFinished"},Fe={pointercancel:"pointercancel",pointerdown:"pointerdown",pointerenter:"pointerenter",pointerleave:"pointerleave",pointermove:"pointermove",pointerout:"pointerout",pointerover:"pointerover",pointerup:"pointerup"},R={none:"none",thin:"thin",frame:"frame"},de=class{constructor(e){this.chessboard=e,this.visualMoveInput=new ce(this),e.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),e.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.handleResize()})}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(e){this.visualMoveInput.onPointerDown(e)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),b.removeElement(this.svg),this.container.remove()}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){let s=document.createElement("div");s.style.transform="scale(0)",s.style.position="absolute",s.setAttribute("aria-hidden","true"),s.id=e,document.body.appendChild(s);let i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=b.createSvg(this.container);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=b.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=b.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=b.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=b.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=b.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=b.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=b.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){let e=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===R.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===R.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/e,this.scalingY=this.squareHeight/e,this.pieceXTranslate=this.squareWidth/2-e*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.container.clientWidth!==this.width||this.container.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(v.beforeRedrawBoard),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(v.afterRedrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(b.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===R.frame){let t=this.borderSize;b.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2}).setAttribute("class","border-inner")}for(let t=0;t<64;t++){let s=this.chessboard.state.orientation===C.white?t:63-t,r=`square ${(9*s&8)===0?"black":"white"}`,o=this.squareToPoint(T.indexToSquare(s)),n=b.addElement(this.boardGroup,"rect",{x:o.x,y:o.y,width:this.squareWidth,height:this.squareHeight});n.setAttribute("class",r),n.setAttribute("data-square",T.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);let e=this.chessboard.props.style.borderType!==R.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*t)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";e&&(s=s+this.scalingX*15.5,r+=t%2?" white":" black");let o=b.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===C.white?o.textContent=String.fromCharCode(97+t):o.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===R.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));let o=b.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===C.white?o.textContent=""+(8-t):o.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){let t=Array.from(this.piecesGroup.childNodes),s=this.visualMoveInput.isDragging();for(let i=0;i<64;i++){let r=e[i];if(r){let o=T.indexToSquare(i);this.drawPieceOnSquare(o,r,s&&o===this.visualMoveInput.fromSquare)}}for(let i of t)this.piecesGroup.removeChild(i)}drawPiece(e,t,s){let i=b.addElement(e,"g",{});i.setAttribute("data-piece",t);let r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);let o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),n=b.addElement(i,"use",{href:`${o}#${t}`,class:"piece"}),a=this.svg.createSVGTransform();return a.setScale(this.scalingY,this.scalingY),n.transform.baseVal.appendItem(a),i}drawPieceOnSquare(e,t,s=!1){let i=b.addElement(this.piecesGroup,"g",{});i.setAttribute("data-piece",t),i.setAttribute("data-square",e),s&&i.setAttribute("visibility","hidden");let r=this.squareToPoint(e),o=this.svg.createSVGTransform();o.setTranslate(r.x,r.y),i.transform.baseVal.appendItem(o);let n=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),a=b.addElement(i,"use",{href:`${n}#${t}`,class:"piece"}),d=this.svg.createSVGTransform();d.setTranslate(this.pieceXTranslate,0),a.transform.baseVal.appendItem(d);let l=this.svg.createSVGTransform();return l.setScale(this.scalingY,this.scalingY),a.transform.baseVal.appendItem(l),i}setPieceVisibility(e,t=!0){let s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(!e||e.length<2)return console.warn("invalid square",e),null;let t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||(console.warn("no piece on",e),null)}enableMoveInput(e,t=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");t===C.white?this.chessboard.state.inputWhiteEnabled=!0:t===C.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(v.moveInputToggled,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(v.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(e){let t={chessboard:this.chessboard,type:E.moveInputStarted,square:e,squareFrom:e,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(t.moveInputCallbackResult=this.chessboard.state.moveInputCallback(t)),this.chessboard.state.invokeExtensionPoints(v.moveInput,t),t.moveInputCallbackResult}movingOverSquareCallback(e,t){let s={chessboard:this.chessboard,type:E.movingOverSquare,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(v.moveInput,s)}validateMoveInputCallback(e,t){let s={chessboard:this.chessboard,type:E.validateMoveInput,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(v.moveInput,s),s.moveInputCallbackResult}moveInputCanceledCallback(e,t,s){let i={chessboard:this.chessboard,type:E.moveInputCanceled,reason:s,squareFrom:e,squareTo:t};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(v.moveInput,i)}moveInputFinishedCallback(e,t,s){let i={chessboard:this.chessboard,type:E.moveInputFinished,squareFrom:e,squareTo:t,legalMove:s};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(v.moveInput,i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===C.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){let t=T.squareToIndex(e);return this.indexToPoint(t)}getSpriteUrl(){return P.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}};var F={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"};var Je={svgSprite:"svgSprite"};var ue=class{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.context=e,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:X.empty,orientation:C.white,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:R.none,aspectRatio:1,pieces:{type:Je.svgSprite,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},P.mergeObjects(this.props,t),this.state=new he,this.view=new de(this),this.positionAnimationsQueue=new le(this),this.state.orientation=this.props.orientation;for(let s of this.props.extensions)this.addExtension(s.class,s.props);this.view.redrawBoard(),this.state.position=new T(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(v.positionChanged),this.initialized=Promise.resolve()}async setPiece(e,t,s=!1){let i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(v.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){let i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(v.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,t=!1){let s=this.state.position.clone(),i=new T(e);return s.getFen()!==i.getFen()&&(this.state.position.setFen(e),this.state.invokeExtensionPoints(v.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),t)}async setOrientation(e,t=!1){let s=this.state.position.clone();if(this.boardTurning){console.warn("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(v.boardChanged)})}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}isMoveInputEnabled(){return this.state.inputWhiteEnabled||this.state.inputBlackEnabled}enableSquareSelect(e=Fe.pointerdown,t){this.squareSelectListener||(this.squareSelectListener=function(s){let i=s.target.getAttribute("data-square");t({eventType:s.type,event:s,chessboard:this,square:i})}),this.context.addEventListener(e,this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(e){this.context.removeEventListener(e,this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}isSquareSelectEnabled(){return this.state.squareSelectEnabled}addExtension(e,t){if(this.getExtension(e))throw Error('extension "'+e.name+'" already added');this.extensions.push(new e(this,t))}getExtension(e){for(let t of this.extensions)if(t instanceof e)return t;return null}destroy(){this.state.invokeExtensionPoints(v.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}};var Y={frame:{class:"marker-frame",slice:"markerFrame"},framePrimary:{class:"marker-frame-primary",slice:"markerFrame"},frameDanger:{class:"marker-frame-danger",slice:"markerFrame"},circle:{class:"marker-circle",slice:"markerCircle"},circlePrimary:{class:"marker-circle-primary",slice:"markerCircle"},circleDanger:{class:"marker-circle-danger",slice:"markerCircle"},square:{class:"marker-square",slice:"markerSquare"},dot:{class:"marker-dot",slice:"markerDot",position:"above"},bevel:{class:"marker-bevel",slice:"markerBevel"}},pe=class extends H{constructor(e,t={}){super(e),this.registerExtensionPoint(v.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={autoMarkers:Y.frame,sprite:"extensions/markers/markers.svg"},Object.assign(this.props,t),e.props.assetsCache&&e.view.cacheSpriteToDiv("cm-chessboard-markers",this.getSpriteUrl()),e.addMarker=this.addMarker.bind(this),e.getMarkers=this.getMarkers.bind(this),e.removeMarkers=this.removeMarkers.bind(this),e.addLegalMovesMarkers=this.addLegalMovesMarkers.bind(this),e.removeLegalMovesMarkers=this.removeLegalMovesMarkers.bind(this),this.markerGroupDown=b.addElement(e.view.markersLayer,"g",{class:"markers"}),this.markerGroupUp=b.addElement(e.view.markersTopLayer,"g",{class:"markers"}),this.markers=[],this.props.autoMarkers&&(Object.assign(this.props.autoMarkers,this.props.autoMarkers),this.registerExtensionPoint(v.moveInput,s=>{this.drawAutoMarkers(s)}))}drawAutoMarkers(e){e.type!==E.moveInputFinished&&this.removeMarkers(this.props.autoMarkers),!(e.type===E.moveInputStarted&&!e.moveInputCallbackResult)&&(e.type===E.moveInputStarted||e.type===E.movingOverSquare)&&(e.squareFrom&&this.addMarker(this.props.autoMarkers,e.squareFrom),e.squareTo&&this.addMarker(this.props.autoMarkers,e.squareTo))}onRedrawBoard(){for(;this.markerGroupUp.firstChild;)this.markerGroupUp.removeChild(this.markerGroupUp.firstChild);for(;this.markerGroupDown.firstChild;)this.markerGroupDown.removeChild(this.markerGroupDown.firstChild);this.markers.forEach(e=>{this.drawMarker(e)})}addLegalMovesMarkers(e){for(let t of e)t.promotion&&t.promotion!=="q"||(this.chessboard.getPiece(t.to)?this.chessboard.addMarker(Y.bevel,t.to):this.chessboard.addMarker(Y.dot,t.to))}removeLegalMovesMarkers(){this.chessboard.removeMarkers(Y.bevel),this.chessboard.removeMarkers(Y.dot)}drawMarker(e){let t;e.type.position==="above"?t=b.addElement(this.markerGroupUp,"g"):t=b.addElement(this.markerGroupDown,"g"),t.setAttribute("data-square",e.square);let s=this.chessboard.view.squareToPoint(e.square),i=this.chessboard.view.svg.createSVGTransform();i.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(i);let r=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),o=b.addElement(t,"use",{href:`${r}#${e.type.slice}`,class:"marker "+e.type.class}),n=this.chessboard.view.svg.createSVGTransform();return n.setScale(this.chessboard.view.scalingX,this.chessboard.view.scalingY),o.transform.baseVal.appendItem(n),t}addMarker(e,t){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.markers.push(new Pe(t,e)),this.onRedrawBoard()}getMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}let s=[];return this.markers.forEach(i=>{i.matches(t,e)&&s.push(i)}),s}removeMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.markers=this.markers.filter(s=>!s.matches(t,e)),this.onRedrawBoard()}getSpriteUrl(){return P.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}},Pe=class{constructor(e,t){this.square=e,this.type=t}matches(e=void 0,t=void 0){if(!t&&!e)return!0;if(t){if(e){if(this.type===t&&e===this.square)return!0}else if(this.type===t)return!0}else if(e===this.square)return!0;return!1}};var L={hidden:"hidden",displayRequested:"displayRequested",shown:"shown"},ie={pieceSelected:"pieceSelected",canceled:"canceled"},fe=class extends H{constructor(e){super(e),this.registerExtensionPoint(v.afterRedrawBoard,this.extensionPointRedrawBoard.bind(this)),e.showPromotionDialog=this.showPromotionDialog.bind(this),e.isPromotionDialogShown=this.isPromotionDialogShown.bind(this),this.promotionDialogGroup=b.addElement(e.view.interactiveTopLayer,"g",{class:"promotion-dialog-group"}),this.state={displayState:L.hidden,callback:null,dialogParams:{square:null,color:null}}}showPromotionDialog(e,t,s){this.state.dialogParams.square=e,this.state.dialogParams.color=t,this.state.callback=s,this.setDisplayState(L.displayRequested),setTimeout(()=>{this.chessboard.view.positionsAnimationTask.then(()=>{this.setDisplayState(L.shown)})})}isPromotionDialogShown(){return this.state.displayState===L.shown||this.state.displayState===L.displayRequested}extensionPointRedrawBoard(){this.redrawDialog()}drawPieceButton(e,t){let s=this.chessboard.view.squareWidth,i=this.chessboard.view.squareHeight;b.addElement(this.promotionDialogGroup,"rect",{x:t.x,y:t.y,width:s,height:i,class:"promotion-dialog-button","data-piece":e}),this.chessboard.view.drawPiece(this.promotionDialogGroup,e,t)}redrawDialog(){for(;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.displayState===L.shown){let e=this.chessboard.view.squareWidth,t=this.chessboard.view.squareHeight,s=this.chessboard.view.squareToPoint(this.state.dialogParams.square);s.x=s.x+e/2,s.y=s.y+t/2;let i=!1,r=parseInt(this.state.dialogParams.square.charAt(1),10);(this.chessboard.getOrientation()===C.white&&r<5||this.chessboard.getOrientation()===C.black&&r>=5)&&(i=!0);let o=i?-4*t:0,n=s.x+e>this.chessboard.view.width?-e:0;b.addElement(this.promotionDialogGroup,"rect",{x:s.x+n,y:s.y+o,width:e,height:t*4,class:"promotion-dialog"});let a=this.state.dialogParams;i?(this.drawPieceButton(F[a.color+"q"],{x:s.x+n,y:s.y-t}),this.drawPieceButton(F[a.color+"r"],{x:s.x+n,y:s.y-t*2}),this.drawPieceButton(F[a.color+"b"],{x:s.x+n,y:s.y-t*3}),this.drawPieceButton(F[a.color+"n"],{x:s.x+n,y:s.y-t*4})):(this.drawPieceButton(F[a.color+"q"],{x:s.x+n,y:s.y}),this.drawPieceButton(F[a.color+"r"],{x:s.x+n,y:s.y+t}),this.drawPieceButton(F[a.color+"b"],{x:s.x+n,y:s.y+t*2}),this.drawPieceButton(F[a.color+"n"],{x:s.x+n,y:s.y+t*3}))}}promotionDialogOnClickPiece(e){e.button!==2&&(e.target.dataset.piece?(this.state.callback&&this.state.callback({type:ie.pieceSelected,square:this.state.dialogParams.square,piece:e.target.dataset.piece}),this.setDisplayState(L.hidden)):this.promotionDialogOnCancel(e))}promotionDialogOnCancel(e){this.state.displayState===L.shown&&(e.preventDefault(),this.setDisplayState(L.hidden),this.state.callback&&this.state.callback({type:ie.canceled}))}contextMenu(e){e.preventDefault(),this.setDisplayState(L.hidden),this.state.callback&&this.state.callback({type:ie.canceled})}setDisplayState(e){this.state.displayState=e,e===L.shown?(this.clickDelegate=P.delegate(this.chessboard.view.svg,"pointerdown","*",this.promotionDialogOnClickPiece.bind(this)),this.contextMenuListener=this.contextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener)):e===L.hidden&&(this.clickDelegate.remove(),this.chessboard.view.svg.removeEventListener("contextmenu",this.contextMenuListener)),this.redrawDialog()}};var j={en:{colors:{w:"w",b:"b"},colors_long:{w:"White",b:"Black"},pieces:{p:"p",n:"n",b:"b",r:"r",q:"q",k:"k"},pieces_long:{p:"Pawn",n:"Knight",b:"Bishop",r:"Rook",q:"Queen",k:"King"}},de:{colors:{w:"w",b:"s"},colors_long:{w:"Wei\xDF",b:"Schwarz"},pieces:{p:"b",n:"s",b:"l",r:"t",q:"d",k:"k"},pieces_long:{p:"Bauer",n:"Springer",b:"L\xE4ufer",r:"Turm",q:"Dame",k:"K\xF6nig"}}};function me(h,e,t=void 0){let s=j[h].pieces_long[e];return t&&(s+=" "+j[h].colors_long[t]),s}var et={de:{chessboard:"Schachbrett",pieces_lists:"Figurenlisten",board_as_table:"Schachbrett als Tabelle",move_piece:"Figur bewegen",from:"Zug von",to:"Zug nach",move:"Zug ausf\xFChren",input_white_enabled:"Eingabe Wei\xDF aktiviert",input_black_enabled:"Eingabe Schwarz aktiviert",input_disabled:"Eingabe deaktiviert",pieces:"Figuren"},en:{chessboard:"Chessboard",pieces_lists:"Pieces lists",board_as_table:"Chessboard as table",move_piece:"Move piece",from:"Move from",to:"Move to",move:"Make move",input_white_enabled:"Input white enabled",input_black_enabled:"Input black enabled",input_disabled:"Input disabled",pieces:"Pieces"}},be=class extends H{constructor(e,t){if(super(e),this.props={language:navigator.language.substring(0,2).toLowerCase(),brailleNotationInAlt:!0,movePieceForm:!0,boardAsTable:!0,piecesAsList:!0,visuallyHidden:!0},Object.assign(this.props,t),this.props.language!=="de"&&this.props.language!=="en"&&(this.props.language="en"),this.lang=this.props.language,this.tPieces=j[this.lang],this.t=et[this.lang],this.components=[],this.props.movePieceForm||this.props.boardAsTable||this.props.piecesAsList){let s=document.createElement("div");s.classList.add("cm-chessboard-accessibility"),this.chessboard.context.appendChild(s),this.props.visuallyHidden&&s.classList.add("visually-hidden"),this.props.movePieceForm&&this.components.push(new Te(s,this)),this.props.boardAsTable&&this.components.push(new qe(s,this)),this.props.piecesAsList&&this.components.push(new Ie(s,this))}this.props.brailleNotationInAlt&&this.components.push(new Ce(this))}},Ce=class{constructor(e){this.extension=e,e.registerExtensionPoint(v.positionChanged,()=>{this.redraw()})}redraw(){let e=this.extension.chessboard.state.position.getPieces(),t=j[this.extension.lang].colors.w.toUpperCase()+":",s=j[this.extension.lang].colors.b.toUpperCase()+":";for(let r of e){let o=r.type==="p"?"":j[this.extension.lang].pieces[r.type].toUpperCase();r.color==="w"?t+=" "+o+r.position:s+=" "+o+r.position}let i=`${t}
${s}`;this.extension.chessboard.view.svg.setAttribute("alt",i)}},Te=class{constructor(e,t){this.chessboard=t.chessboard,this.movePieceFormContainer=P.createDomElement(`
<div>
    <h3 id="hl_form_${this.chessboard.id}">${t.t.move_piece}</h3>
    <form aria-labelledby="hl_form_${this.chessboard.id}">
        <label for="move_piece_input_from_${this.chessboard.id}">${t.t.from}</label>
        <input class="input-from" type="text" size="2" id="move_piece_input_from_${this.chessboard.id}"/>
        <label for="move_piece_input_to_${this.chessboard.id}">${t.t.to}</label>
        <input class="input-to" type="text" size="2" id="move_piece_input_to_${this.chessboard.id}"/>
        <button type="submit" class="button-move">${t.t.move}</button>
    </form>
</div>`),this.form=this.movePieceFormContainer.querySelector("form"),this.inputFrom=this.form.querySelector(".input-from"),this.inputTo=this.form.querySelector(".input-to"),this.moveButton=this.form.querySelector(".button-move"),this.form.addEventListener("submit",s=>{s.preventDefault(),this.chessboard.state.moveInputCallback({chessboard:this.chessboard,type:E.validateMoveInput,squareFrom:this.inputFrom.value,squareTo:this.inputTo.value})&&this.chessboard.movePiece(this.inputFrom.value,this.inputTo.value,!0).then(()=>{this.inputFrom.value="",this.inputTo.value=""})}),e.appendChild(this.movePieceFormContainer),t.registerExtensionPoint(v.moveInputToggled,()=>{this.redraw()})}redraw(){this.inputFrom&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?(this.inputFrom.disabled=!1,this.inputTo.disabled=!1,this.moveButton.disabled=!1):(this.inputFrom.disabled=!0,this.inputTo.disabled=!0,this.moveButton.disabled=!0))}},qe=class{constructor(e,t){this.extension=t,this.chessboard=t.chessboard,this.boardAsTableContainer=P.createDomElement(`<div><h3 id="hl_table_${this.chessboard.id}">${t.t.board_as_table}</h3><div class="table"></div></div>`),this.boardAsTable=this.boardAsTableContainer.querySelector(".table"),e.appendChild(this.boardAsTableContainer),t.registerExtensionPoint(v.positionChanged,()=>{this.redraw()}),t.registerExtensionPoint(v.boardChanged,()=>{this.redraw()})}redraw(){let e=this.chessboard.state.position.squares.slice(),t=["a","b","c","d","e","f","g","h"],s=["8","7","6","5","4","3","2","1"];this.chessboard.state.orientation===C.black&&(t.reverse(),s.reverse(),e.reverse());let i=`<table aria-labelledby="hl_table_${this.chessboard.id}"><tr><th></th>`;for(let r of t)i+=`<th scope='col'>${r}</th>`;i+="</tr>";for(let r=7;r>=0;r--){i+=`<tr><th scope="row">${s[7-r]}</th>`;for(let o=0;o<8;o++){let n=e[o%8+r*8],a,d;n?(a=n.charAt(0),d=n.charAt(1),i+=`<td>${me(this.extension.lang,d,a)}</td>`):i+="<td></td>"}i+="</tr>"}i+="</table>",this.boardAsTable.innerHTML=i}},Ie=class{constructor(e,t){this.extension=t,this.chessboard=t.chessboard,this.piecesListContainer=P.createDomElement(`<div><h3 id="hl_lists_${this.chessboard.id}">${t.t.pieces_lists}</h3><div class="list"></div></div>`),this.piecesList=this.piecesListContainer.querySelector(".list"),e.appendChild(this.piecesListContainer),t.registerExtensionPoint(v.positionChanged,()=>{this.redraw()})}redraw(){let e=this.chessboard.state.position.getPieces(),t="",s="";for(let i of e)i.color==="w"?t+=`<li class="list-inline-item">${me(this.extension.lang,i.type)} ${i.position}</li>`:s+=`<li class="list-inline-item">${me(this.extension.lang,i.type)} ${i.position}</li>`;this.piecesList.innerHTML=`
        <h4 id="white_${this.chessboard.id}">${this.extension.t.pieces} ${this.extension.tPieces.colors_long.w}</h4>
        <ul aria-labelledby="white_${this.chessboard.id}" class="list-inline">${t}</ul>
        <h4 id="black_${this.chessboard.id}">${this.extension.t.pieces} ${this.extension.tPieces.colors_long.b}</h4>
        <ul aria-labelledby="black_${this.chessboard.id}" class="list-inline">${s}</ul>`}};typeof window<"u"&&window!==null&&(window.plugins.chess||(window.plugins.chess={emit:tt,bind:st},(typeof window.chessListener<"u"||window.chessListener==null)&&(console.log("**** Adding chess listener"),window.chessListener=Ue,window.addEventListener("message",Ue))));function tt(h,e){return["chessboard","markers","promotion-dialog"].forEach(t=>{if(![...document.styleSheets].filter(s=>s.ownerNode.hasAttribute("href")).filter(s=>s.href.endsWith(`/plugins/chess/${t}.css`)).length){let s=document.createElement("link");s.rel="stylesheet",s.href=`/plugins/chess/${t}.css`,s.type="text/css",document.getElementsByTagName("head")[0].appendChild(s)}}),h.append(Be("loading board..."))}function Be(h){return`
    <div class="table" data-item="table" style="width:98%">
      <div style="width:80%; padding:8px; color:gray; background-color:#eee; margin:0 auto; text-align:center">
        <i>${h}</i>
      </div>
    </div>
  `}async function st(h,e){try{let n=function(l){if(l.type===E.moveInputStarted){let _=s.moves({square:l.squareFrom,verbose:!0});return l.chessboard.addLegalMovesMarkers(_),_.length>0}else if(l.type===E.validateMoveInput){let _={from:l.squareFrom,to:l.squareTo,promotion:l.promotion};try{let c=s.move(_);l.chessboard.state.moveInputProcess.then(()=>{l.chessboard.setPosition(s.fen(),!0).then(()=>{a(l.chessboard)})})}catch{let c=s.moves({square:l.squareFrom,verbose:!0});for(let p of c)if(p.promotion&&p.to===l.squareTo)return l.chessboard.showPromotionDialog(l.squareTo,C.white,w=>{w.type===ie.pieceSelected?(s.move({from:l.squareFrom,to:l.squareTo,promotion:w.piece.charAt(1)}),l.chessboard.setPosition(s.fen(),!0),a(l.chessboard)):(l.chessboard.enableMoveInput(n,C.white),l.chessboard.setPosition(s.fen(),!0))}),!0}return}else l.type===E.moveInputFinished&&l.legalMove&&l.chessboard.disableMoveInput();l.type!==E.moveInputFinished&&l.chessboard.removeLegalMovesMarkers(),l.type,E.movingOverSquare},a=function(l){let _=s.moves({verbose:!0});if(_.length>0){let c=Math.floor(Math.random()*_.length),p=_[c];setTimeout(()=>{s.move({from:p.from,to:p.to}),l.setPosition(s.fen(),!0)},500)}d()},d=function(){let l="";s.isCheckmate()&&s.turn()==="w"?l="Game over: white is in checkmate. Black wins!":s.isCheckmate()&&s.turn()==="b"?l="Game over: black is in checkmate. White wins!":s.isStalemate()&&s.turn()==="w"?l="Game is drawn. White is stalemated.":s.isStalemate()&&s.turn()==="b"?l="Game is drawn. Black is stalemated.":s.isThreefoldRepetition()?l="Game is drawn by threefold repetition rule.":s.isInsufficientMaterial()?l="Game is drawn by insufficient material.":s.isDraw()?l="Game is drawn by fifty-move rule.":l="Game is ongoing.",document.getElementById("gameStatus").innerHTML=l,s.isGameOver()&&console.log(s.PGN())},s=new ae,i=await it(h,e),r=Date.now();h.find(".table").html(`
      <div id="board-${r}" class="board board-large" style="width: 400px"></div>
      <p id="gameStatus"></p>
    `);let o=new ue(document.getElementById(`board-${r}`),{position:s.fen(),assetsUrl:"/plugins/chess/assets/",style:{borderType:R.none,pieces:{file:"pieces/staunty.svg"},animationDuration:300},orientation:C.white,extensions:[{class:pe,props:{autoMarkers:Y.square}},{class:fe},{class:be,props:{visuallyHidden:!0}}]});d(),o.enableMoveInput(n,C.white)}catch(s){console.log("makePGN",s),h.html(Be(s.message))}h.on("dblclick",()=>wiki.textEditor(h,e)),h.on("click",s=>{});function t(s,i){var r=document.createElement("a");r.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(i)),r.setAttribute("download",s),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}}async function it(h,e){return e.text;function t(s,i){throw new Error(s+`
`+i)}}function Ue(h){if(!h.source.opener||h.source.location.pathname!=="/plugins/chess/dialog/"){wiki.debug&&console.log("chessListener - not for us",{event:h});return}wiki.debug&&console.log("chessListener - ours",{event:h});let{data:e}=h,{action:t,keepLineup:s=!1,pageKey:i=null,title:r=null,context:o=null}=e,n=null;switch(i!=null&&(n=s?null:$(".page").filter((a,d)=>$(d).data("key")==i)),t){case"doInternalLink":wiki.pageHandler.context=o,wiki.doInternalLink(r,n);break;default:console.error({where:"chessListener",message:"unknown action",data:e})}}var rt=h=>h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*(.+?)\*/g,"<i>$1</i>"),es=typeof window>"u"?{expand:rt}:void 0;})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
//# sourceMappingURL=chess.js.map
